<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$US402 Token Launch</title>
    <style>
        body {
            font-family: monospace, Courier New;
            margin: 40px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 0;
        }
        h1 {
            color: #ff6600; 
            font-size: 2.2em;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        h2 {
            color: #333;
            font-size: 1.2em;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        ul { list-style-type: none; padding-left: 0; margin-left: 0; }
        ul.tokenomics li { margin-bottom: 5px; } 
        
        a { color: #007bff; text-decoration: none; }
        
        .button-container {
            display: flex;
            gap: 10px; 
        }
        
        #connectWalletBtn, #approveBtn, #mintBtn {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-family: monospace; 
        }
        #connectWalletBtn { background-color: #ff6600; color: white; }
        #approveBtn { background-color: #007bff; color: white; }
        #mintBtn { background-color: #28a745; color: white; } 

        #approveBtn:disabled, #mintBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        #errorMessage { color: red; font-weight: bold; }
        #statusMessage { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>$US402</h1>

        <p>The inaugural native web payment framework designed to reward X402 adoption with yield tokens. X402: what is it?</p>

        <h2>Domain</h2>
        <p>us-ai.fun</p>

        <h2>Mint Token</h2>
        <p>Price: 1000 $US402 per 1 USDC. (2-step process: Approve, then Mint)</p>
        
        <div class="button-container">
            <button id="connectWalletBtn">Connect Wallet</button>
            <button id="approveBtn" style="display: none;">1. Approve 1 USDC</button>
            <button id="mintBtn" style="display: none;" disabled>2. Mint 1000 $US402</button>
        </div>

        <div id="statusMessage" style="margin-top: 15px;"></div>
        <div id="errorMessage" style="margin-top: 5px;"></div>

        <h2>Tokenomics</h2>
        <ul class="tokenomics">
            <li>Mint Amount: 1000 $US402 per transaction</li>
            <li>Price: 1 USDC</li>
            <li>Cap: 100K $USDC total</li>
            <li>LP: 100% of proceeds go into LP</li>
            <li>Team Supply: No team supply</li>
            <li>Utility: None - pure meme token</li>
            <li>Refunds: No refunds</li>
            <li>Liquidity: Only provided on mint out</li>
        </ul>

        <h2>X402 Payment Data (Info)</h2>
        <p>
            Struktur data ini mendefinisikan detail pembayaran untuk 
            integrasi dengan standar X402.
        </p>
        <ul class="tokenomics">
            <li><strong>Scheme:</strong> "exact"</li>
            <li><strong>Network:</strong> "base"</li>
            <li><strong>Description:</strong> "Mint 1000 $US402 Tokens"</li>
            <li><strong>Asset (USDC):</strong> "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"</li>
            <li><strong>Pay To (Sale Contract):</strong> "0xa07cb30bdfd6c55cfbd3ed5949219190a60fbadc"</li>
            <li><strong>Amount Required (Price):</strong> "1000000" (1 USDC, 6 desimal)</li>
        </ul>

        <h2>Social</h2>
        <p>Follow <a href="https://x.com/us402fun">@us402fun</a> on X</p>

        <div class="warning">
            ⚠️ Warning: Use at your own risk. NO financial advice.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        // *******************************************************************
        // SCRIPT DIPERBAIKI UNTUK ERROR 'allowance.lt'
        // *******************************************************************
        
        const CONTRACT_SALE_ADDRESS = "0xa07cb30bdfd6c55cfbd3ed5949219190a60fbadc";
        const USDC_CONTRACT_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"; 
        const CHAIN_ID = 8453; 
        const USDC_PRICE_TX = '1000000'; 

        const saleABI = [
            "function buyTokens(uint256 _usdcAmountToSpend)"
        ];
        const usdcABI = [
            "function approve(address spender, uint256 amount)",
            "function allowance(address owner, address spender)"
        ];

        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const approveBtn = document.getElementById('approveBtn');
        const mintBtn = document.getElementById('mintBtn');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');

        let signer;
        let provider;
        let userAddress;
        let saleContract;
        let usdcContract;

        // --- 1. CONNECT WALLET ---
        async function connectWallet() {
            errorMessage.textContent = '';
            statusMessage.textContent = 'Connecting...';
            if (typeof window.ethereum === 'undefined') {
                errorMessage.textContent = "Metamask not detected. Please install Metamask.";
                return;
            }

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                const { chainId } = await provider.getNetwork();
                if (chainId !== CHAIN_ID) {
                    errorMessage.textContent = `Please switch to the Base Mainnet (${CHAIN_ID}).`;
                    return;
                }

                saleContract = new ethers.Contract(CONTRACT_SALE_ADDRESS, saleABI, signer);
                usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, usdcABI, signer);

                connectWalletBtn.style.display = 'none';
                approveBtn.style.display = 'block';
                mintBtn.style.display = 'block';
                statusMessage.textContent = `Wallet Connected: ${userAddress.substring(0, 6)}...`;

                await checkAllowance();

            } catch (error) {
                errorMessage.textContent = `Connection aborted: ${error.message}`;
            }
        }

        // --- 2. CEK ALLOWANCE PENGGUNA (DENGAN PERBAIKAN) ---
        async function checkAllowance() {
            try {
                statusMessage.textContent = 'Checking USDC allowance...';
                
                // Panggil kontrak untuk data allowance
                const allowance = await usdcContract.allowance(userAddress, CONTRACT_SALE_ADDRESS);
                
                // --- PERBAIKAN ---
                // Periksa apakah 'allowance' adalah objek BigNumber yang valid
                if (allowance && typeof allowance.lt === 'function') {
                
                    if (allowance.lt(ethers.BigNumber.from(USDC_PRICE_TX))) {
                        // Jika allowance kurang, aktifkan tombol Approve
                        approveBtn.disabled = false;
                        approveBtn.textContent = '1. Approve 1 USDC';
                        mintBtn.disabled = true;
                        mintBtn.style.backgroundColor = '#ccc'; 
                        statusMessage.textContent = 'Please approve 1 USDC to continue.';
                    } else {
                        // Jika sudah diapprove, nonaktifkan tombol Approve
                        approveBtn.disabled = true;
                        approveBtn.textContent = 'USDC Approved';
                        mintBtn.disabled = false;
                        mintBtn.style.backgroundColor = '#28a745'; 
                        statusMessage.textContent = 'Ready to mint.';
                    }
                    
                } else {
                    // Jika 'allowance' bukan BigNumber, tampilkan error RPC
                    console.error("Allowance value is not a BigNumber:", allowance);
                    errorMessage.textContent = 'Failed to read allowance. Is your RPC connection stable? Please refresh.';
                }
                // --- AKHIR PERBAIKAN ---

            } catch (error) {
                // Tangkap error jika panggilan 'allowance' gagal total
                errorMessage.textContent = 'Failed to check allowance. Check console (F12).';
                console.error("Error in checkAllowance:", error);
            }
        }

        // --- 3. FUNGSI APPROVE USDC ---
        async function approveUSDC() {
            errorMessage.textContent = '';
            statusMessage.textContent = 'Waiting for approve signature...';
            approveBtn.disabled = true;

            try {
                const tx = await usdcContract.approve(CONTRACT_SALE_ADDRESS, USDC_PRICE_TX);
                statusMessage.textContent = 'Approving USDC... Tx Hash: ' + tx.hash.substring(0, 10) + '...';
                await tx.wait();
                
                statusMessage.textContent = '✅ Approved! You can now mint.';
                await checkAllowance(); 

            } catch (error) {
                approveBtn.disabled = false; 
                errorMessage.textContent = 'Approve transaction failed or was rejected.';
                console.error(error);
            }
        }

        // --- 4. FUNGSI MINT TOKEN ---
        async function mintToken() {
            errorMessage.textContent = '';
            statusMessage.textContent = 'Waiting for mint signature...';
            mintBtn.disabled = true;
            mintBtn.style.backgroundColor = '#ccc';

            try {
                const tx = await saleContract.buyTokens(USDC_PRICE_TX, {
                    gasLimit: 300000 
                });
                
                statusMessage.textContent = 'Minting... Tx Hash: ' + tx.hash.substring(0, 10) + '...';
                await tx.wait();

                statusMessage.innerHTML = `✅ **Mint Success!** 1000 $US402 sent! <br>Tx: <a href="https://basescan.org/tx/${tx.hash}" target="_blank">View on Basescan</a>`;
                
                await checkAllowance(); 

            } catch (error) {
                mintBtn.disabled = false; 
                mintBtn.style.backgroundColor = '#28a745';
                errorMessage.textContent = 'Mint Failed. (Did you approve enough USDC?)';
                console.error(error);
            }
        }

        // --- EVENT LISTENERS ---
        connectWalletBtn.addEventListener('click', connectWallet);
        approveBtn.addEventListener('click', approveUSDC);
        mintBtn.addEventListener('click', mintToken);

    </script>
</body>
</html>
