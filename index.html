<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$US402 Token Launch</title>
    <style>
        body { font-family: monospace, Courier New; margin: 40px; color: #333; }
        .container { max-width: 800px; margin: auto; padding: 0; }
        h1 { color: #ff6600; font-size: 2.2em; padding-bottom: 5px; margin-bottom: 15px; }
        h2 { color: #333; font-size: 1.2em; margin-top: 25px; margin-bottom: 10px; }
        ul { list-style-type: none; padding-left: 0; margin-left: 0; }
        a { color: #007bff; text-decoration: none; }
        #connectWalletBtn, #mintTokenBtn { padding: 10px 20px; font-size: 16px; border: none; cursor: pointer; border-radius: 5px; transition: background-color 0.3s; font-family: monospace; }
        #connectWalletBtn { background-color: #ff6600; color: white; }
        #mintTokenBtn { background-color: #007bff; color: white; }
        #mintTokenBtn:disabled { background-color: #ccc; cursor: not-allowed; }
        #errorMessage { color: red; font-weight: bold; }
        #statusMessage { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>$US402</h1>
        <p>Price: 1000 $US402 per 1 USDC. **1x Sign-In** for efficient transaction.</p>
        
        <button id="connectWalletBtn">Connect Wallet</button>
        <button id="mintTokenBtn" style="display: none;" disabled>Mint 1000 $US402 (1 USDC)</button>

        <div id="statusMessage" style="margin-top: 15px;"></div>
        <div id="errorMessage" style="margin-top: 5px;"></div>

        </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        // *******************************************************************
        // SCRIPT FRONTEND UNTUK ALUR GASLESS (1-SIGN)
        // *******************************************************************

        // GANTI INI DENGAN ALAMAT IP PUBLIK VPS ANDA
        const RELAYER_URL = "http://54.83.109.188:3000/mint"; 

        // Ganti dengan alamat 'TokenSalePermit' BARU Anda (dari Bagian 3)
        const CONTRACT_SALE_MANAGER_ADDRESS = "0xb817A9877B1dfACD4Afc82Ce07038f80867f2a4E";
        
        const USDC_CONTRACT_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"; 
        const CHAIN_ID = 8453; // Base Mainnet
        const USDC_PRICE_TX = '1000000'; // 1 USDC

        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const mintTokenBtn = document.getElementById('mintTokenBtn');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');

        let signer;
        let provider;
        let userAddress;

        // --- WALLET CONNECTION ---
        async function connectWallet() {
            errorMessage.textContent = '';
            statusMessage.textContent = 'Connecting...';
            if (typeof window.ethereum === 'undefined') {
                errorMessage.textContent = "Metamask not detected.";
                return;
            }
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                const { chainId } = await provider.getNetwork();
                if (chainId !== CHAIN_ID) {
                    errorMessage.textContent = `Please switch to the Base Mainnet.`;
                    return;
                }
                connectWalletBtn.style.display = 'none';
                mintTokenBtn.style.display = 'block';
                mintTokenBtn.disabled = false;
                statusMessage.textContent = `Wallet Connected: ${userAddress.substring(0, 6)}...`;
            } catch (error) {
                errorMessage.textContent = `Connection aborted.`;
            }
        }

        // --- MINT FUNCTION (GASLESS) ---
        async function mintToken() {
            errorMessage.textContent = '';
            statusMessage.textContent = '1. Requesting Permit Signature (Gas-Free)...';
            mintTokenBtn.disabled = true;

            try {
                // --- 1. BUAT TANDA TANGAN (SAMA SEPERTI SEBELUMNYA) ---
                const currentTimestamp = Math.floor(Date.now() / 1000);
                const validBefore = currentTimestamp + (60 * 15); // 15 menit
                const validAfter = 0; 
                const nonce = ethers.utils.solidityKeccak256(["uint256", "uint256"], [userAddress, Date.now()]);

                const domain = {
                    name: 'USD Coin', version: '2',
                    chainId: CHAIN_ID, verifyingContract: USDC_CONTRACT_ADDRESS,
                };
                const types = {
                    TransferWithAuthorization: [
                        { name: 'from', type: 'address' }, { name: 'to', type: 'address' },
                        { name: 'value', type: 'uint256' }, { name: 'validAfter', type: 'uint256' },
                        { name: 'validBefore', type: 'uint256' }, { name: 'nonce', type: 'bytes32' },
                    ],
                };
                const message = {
                    from: userAddress,
                    to: CONTRACT_SALE_MANAGER_ADDRESS, 
                    value: USDC_PRICE_TX,
                    validAfter: validAfter, validBefore: validBefore, nonce: nonce,
                };

                // --- 2. PENGGUNA TANDA TANGAN (POP-UP 1 - GRATIS) ---
                const signature = await signer._signTypedData(domain, types, message);
                const signatureParts = ethers.utils.splitSignature(signature);

                statusMessage.textContent = '2. Signature obtained. Sending to server... (Gasless)';

                // --- 3. KIRIM TANDA TANGAN KE SERVER (VPS) ANDA ---
                // TIDAK ADA POP-UP 2 UNTUK PENGGUNA
                const response = await fetch(RELAYER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        buyerAddress: userAddress, // Kirim alamat pembeli
                        validAfter: message.validAfter,
                        validBefore: message.validBefore,
                        nonce: message.nonce,
                        v: signatureParts.v,
                        r: signatureParts.r,
                        s: signatureParts.s
                    })
                });

                const result = await response.json();

                // --- 4. TAMPILKAN HASIL DARI SERVER ---
                if (result.success) {
                    statusMessage.innerHTML = `âœ… **Mint Success!** 1000 $US402$ sent! <br>Tx: <a href="https://basescan.org/tx/${result.txHash}" target="_blank">View on Basescan</a>`;
                } else {
                    errorMessage.textContent = `Mint Failed: ${result.error}`;
                }
                
            } catch (error) {
                if (error.code === 4001) { 
                    errorMessage.textContent = 'Transaction signature denied by the user.';
                } else {
                    errorMessage.textContent = 'Signature Failed. Check console (F12).';
                }
                console.error("Signature error:", error);
            } finally {
                mintTokenBtn.disabled = false;
            }
        }
        connectWalletBtn.addEventListener('click', connectWallet);
        mintTokenBtn.addEventListener('click', mintToken);
    </script>
</body>
</html>
