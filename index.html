<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        // *******************************************************************
        // !!! ALAMAT KONTRAK FINAL YANG SUDAH DI-DEPLOY DI BASE MAINNET !!!
        // *******************************************************************
        const CONTRACT_SALE_MANAGER_ADDRESS = "0xbd44118436691de975e78908b3d7b3422ca69f53"; 
        
        // Base Network Configuration
        const USDC_CONTRACT_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"; 
        const CHAIN_ID = 8453; // Base Mainnet
        const USDC_PRICE_TX = '1000000'; // 1 USDC (6 desimal)

        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const mintTokenBtn = document.getElementById('mintTokenBtn');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');

        let signer;
        let provider;
        let userAddress;

        // Minimal ABI untuk fungsi buyTokenWithPermit
        const saleManagerABI = [
            "function buyTokenWithPermit(uint256 validAfter, uint256 validBefore, bytes32 nonce, uint8 v, bytes32 r, bytes32 s)"
        ];

        // --- WALLET CONNECTION FUNCTION (Tidak berubah) ---
        async function connectWallet() {
            errorMessage.textContent = '';
            statusMessage.textContent = 'Connecting...';
            if (typeof window.ethereum === 'undefined') {
                errorMessage.textContent = "Metamask not detected. Please install Metamask.";
                return;
            }

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                const { chainId } = await provider.getNetwork();
                if (chainId !== CHAIN_ID) {
                    errorMessage.textContent = `Please switch to the Base Mainnet (${CHAIN_ID}).`;
                    return;
                }

                connectWalletBtn.style.display = 'none';
                mintTokenBtn.style.display = 'block';
                mintTokenBtn.disabled = false;
                statusMessage.textContent = `Wallet Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;

            } catch (error) {
                errorMessage.textContent = `Connection aborted: ${error.message}`;
            }
        }

        // --- MINT FUNCTION (DENGAN PERBAIKAN WAKTU & NONCE) ---
        async function mintToken() {
            errorMessage.textContent = '';
            statusMessage.textContent = '1. Requesting Permit Signature (Gas-Free)...';
            mintTokenBtn.disabled = true;

            try {
                // *** PERBAIKAN WAKTU VALIDITAS ***
                const currentTimestamp = Math.floor(Date.now() / 1000);
                const validBefore = currentTimestamp + (60 * 15); // Diperpanjang menjadi 15 menit
                const validAfter = 0; // Valid SEGERA (0 adalah Unix Epoch)

                // *** PERBAIKAN NONCE ***
                // Menggunakan kombinasi waktu, alamat, dan angka acak untuk nonce yang lebih unik
                const nonce = ethers.utils.solidityKeccak256(
                    ["uint256", "address", "uint256"], 
                    [Date.now(), userAddress, Math.floor(Math.random() * 1000000)]
                );

                // EIP-712 Domain Data
                const domain = {
                    name: 'USD Coin',
                    version: '2',
                    chainId: CHAIN_ID, 
                    verifyingContract: USDC_CONTRACT_ADDRESS,
                };

                // Permit EIP-3009 types
                const types = {
                    TransferWithAuthorization: [
                        { name: 'from', type: 'address' },
                        { name: 'to', type: 'address' },
                        { name: 'value', type: 'uint256' },
                        { name: 'validAfter', type: 'uint256' },
                        { name: 'validBefore', type: 'uint256' },
                        { name: 'nonce', type: 'bytes32' },
                    ],
                };
                
                // Message Data
                const message = {
                    from: userAddress,
                    to: CONTRACT_SALE_MANAGER_ADDRESS,
                    value: USDC_PRICE_TX,
                    validAfter: validAfter, // Menggunakan 0
                    validBefore: validBefore,
                    nonce: nonce,
                };

                // Minta pengguna menandatangani pesan
                const signature = await signer._signTypedData(domain, types, message);
                const signatureParts = ethers.utils.splitSignature(signature);

                statusMessage.textContent = '2. Signature obtained. Sending Mint transaction (1 Gas Fee)...';

                // Kirim TRANSAKSI TUNGGAL ke Sale Manager
                const saleManagerContract = new ethers.Contract(CONTRACT_SALE_MANAGER_ADDRESS, saleManagerABI, signer);

                const tx = await saleManagerContract.buyTokenWithPermit(
                    message.validAfter,
                    message.validBefore,
                    message.nonce,
                    signatureParts.v,
                    signatureParts.r,
                    signatureParts.s
                );

                statusMessage.textContent = `3. Waiting for confirmation... Tx Hash: ${tx.hash.substring(0, 10)}...`;
                await tx.wait();

                statusMessage.innerHTML = `âœ… **Mint Success!** 1000 $US402$ sent to your wallet. <br>Tx: <a href="https://basescan.org/tx/${tx.hash}" target="_blank">View on Basescan</a>`;

            } catch (error) {
                mintTokenBtn.disabled = false;
                
                // Penanganan Error
                if (error.code === 4001) { 
                    errorMessage.textContent = 'Transaction signature denied by the user.';
                } else if (error.message.includes("UNPREDICTABLE_GAS_LIMIT")) {
                    errorMessage.textContent = 'Failed: The signed permit is likely invalid (expired, or nonce used). Please try refreshing and signing again.';
                } else if (error.data?.message?.includes("Cap") || error.message.includes("insufficient funds")) {
                    errorMessage.textContent = 'Failed: Check funds, or the Cap is reached.';
                } else {
                    errorMessage.textContent = 'Transaction Failed. Check console (F12) for technical details.';
                }
                console.error("Mint transaction error:", error);
            } finally {
                mintTokenBtn.disabled = false;
            }
        }

        // --- EVENT LISTENERS ---
        connectWalletBtn.addEventListener('click', connectWallet);
        mintTokenBtn.addEventListener('click', mintToken);
    </script>
