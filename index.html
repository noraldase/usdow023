<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Required</title>
    <style>
        body { font-family: monospace, Courier New; margin: 40px; color: #333; }
        .container { max-width: 800px; margin: auto; padding: 0; }
        h1 { color: #ff6600; font-size: 2.2em; padding-bottom: 5px; margin-bottom: 15px; }
        #connectWalletBtn, #mintTokenBtn { padding: 10px 20px; font-size: 16px; border: none; cursor: pointer; border-radius: 5px; transition: background-color 0.3s; font-family: monospace; }
        #connectWalletBtn { background-color: #ff6600; color: white; }
        #mintTokenBtn { background-color: #007bff; color: white; }
        #mintTokenBtn:disabled { background-color: #ccc; cursor: not-allowed; }
        #errorMessage { color: red; font-weight: bold; }
        #statusMessage { color: green; }
        #gasDisplay { margin-top: 10px; font-size: 0.9em; color: #555; }
        .warning { margin-top: 20px; padding: 10px; border: 1px solid #ffcc00; background-color: #fff9e6; border-radius: 5px; font-size: 0.9em;}
    </style>
</head>
<body>
    <div class="container">
        <h1>$PONG US402</h1>

        <h2>Mint Token</h2>
        <p>Price: 1000 $PONGUS per 1 USDC</p>
        <p>Supply: 100,000,000 $PONG US402</p>

        <button id="connectWalletBtn">Connect Wallet</button>
        <button id="mintTokenBtn" style="display: none;" disabled>Mint 1000 $PONGUS (1 USDC)</button>

        <div id="gasDisplay"></div>
        <div id="statusMessage" style="margin-top: 15px;"></div>
        <div id="errorMessage" style="margin-top: 5px;"></div>

        <hr style="margin-top: 30px; margin-bottom: 30px; border: 0; border-top: 1px solid #eee;">

        <h2>Social</h2>
        <p>Follow <a href="https://x.com/us402fun" target="_blank" rel="noopener noreferrer">@us402fun</a> on X</p>

        <div class="warning">
            ⚠️ Warning: Use at your own risk. NO financial advice.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        // --- KONFIGURASI FRONTEND ---
        const RELAYER_URL = "https://api.us-ai.fun/mint";
        const CONTRACT_SALE_MANAGER_ADDRESS = "0x5f76ff0AeF8b06a530dDdc7711D3237dF4B83088"; 

        const USDC_CONTRACT_ADDRESS = "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"; 
        const CHAIN_ID = 8453; // Base Mainnet
        const USDC_PRICE_TX = '1000000'; // 1 USDC

        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const mintTokenBtn = document.getElementById('mintTokenBtn');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');
        const gasDisplay = document.getElementById('gasDisplay');

        let signer;
        let provider;
        let userAddress;
        let ownerWalletAddress; 

        const saleManagerABI = [
            "function wallet() view returns (address)",
        ];

        // --- WALLET CONNECTION (DENGAN DETEKSI GAS & AMBIL OWNER WALLET) ---
        async function connectWallet() {
            errorMessage.textContent = '';
            statusMessage.textContent = 'Connecting...';
            gasDisplay.textContent = 'Fetching gas price...';

            if (typeof window.ethereum === 'undefined') {
                errorMessage.textContent = "Metamask not detected."; return;
            }
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                const { chainId } = await provider.getNetwork();
                if (chainId !== CHAIN_ID) {
                    errorMessage.textContent = `Please switch to the Base Mainnet.`; return;
                }

                // Deteksi Harga Gas
                try {
                    const feeData = await provider.getFeeData();
                    const gasPriceInGwei = feeData.gasPrice.div(1000000000);
                    gasDisplay.textContent = `⚡ Current Network Gas: ${gasPriceInGwei.toString()} Gwei`;
                } catch (gasError) {
                    gasDisplay.textContent = 'Could not fetch gas price.';
                }

                // Ambil alamat wallet owner
                statusMessage.textContent = 'Fetching sale configuration...';
                const saleContract = new ethers.Contract(CONTRACT_SALE_MANAGER_ADDRESS, saleManagerABI, provider);
                ownerWalletAddress = await saleContract.wallet();

                if (!ownerWalletAddress) {
                     errorMessage.textContent = 'Failed to read owner wallet address from contract.'; return;
                }

                connectWalletBtn.style.display = 'none';
                mintTokenBtn.style.display = 'block';
                mintTokenBtn.disabled = false;
                statusMessage.textContent = `Wallet Connected: ${userAddress.substring(0, 6)}...`;
            } catch (error) {
                console.error("Connection Error:", error);
                errorMessage.textContent = `Connection aborted or failed to read contract.`;
            }
        }

        // --- MINT FUNCTION (GASLESS) ---
        async function mintToken() {
            errorMessage.textContent = '';
            statusMessage.textContent = '1. Requesting Permit Signature';
            mintTokenBtn.disabled = true;

            if (!ownerWalletAddress) {
                errorMessage.textContent = "Owner wallet not loaded. Please reconnect.";
                mintTokenBtn.disabled = false;
                return;
            }

            let response; // Definisikan di luar try agar bisa diakses di catch
            try {
                // --- 1. Buat Tanda Tangan ---
                const currentTimestamp = Math.floor(Date.now() / 1000);
                const validBefore = currentTimestamp + (60 * 15);
                const validAfter = 0;
                const nonce = ethers.utils.solidityKeccak256(["uint256", "uint256"], [userAddress, Date.now()]);

                const domain = { name: 'USD Coin', version: '2', chainId: CHAIN_ID, verifyingContract: USDC_CONTRACT_ADDRESS };
                const types = { TransferWithAuthorization: [ { name: 'from', type: 'address' }, { name: 'to', type: 'address' }, { name: 'value', type: 'uint256' }, { name: 'validAfter', type: 'uint256' }, { name: 'validBefore', type: 'uint256' }, { name: 'nonce', type: 'bytes32' }, ] };
                const message = { from: userAddress, to: ownerWalletAddress, value: USDC_PRICE_TX, validAfter: validAfter, validBefore: validBefore, nonce: nonce };

                const signature = await signer._signTypedData(domain, types, message);
                const signatureParts = ethers.utils.splitSignature(signature);

                statusMessage.textContent = '2. Signature obtained. Sending to server... (Gasless)';

                // --- 2. KIRIM KE RELAYER ---
                const signatureBody = {
                    buyerAddress: userAddress,
                    validAfter: message.validAfter,
                    validBefore: message.validBefore,
                    nonce: message.nonce,
                    v: signatureParts.v,
                    r: signatureParts.r,
                    s: signatureParts.s
                };

                response = await fetch(RELAYER_URL, { // Assign ke variabel 'response'
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-PAYMENT': 'dummy=true' 
                    },
                    body: JSON.stringify(signatureBody) 
                });
                
                // --- 3. PROSES RESPONS DENGAN HATI-HATI ---
                if (!response.ok) { // Jika status BUKAN 2xx (misal 400, 500)
                    let errorMsg = `Server error (Status ${response.status})`;
                    try {
                         // Coba baca body error sebagai JSON
                         const errorBody = await response.json();
                         errorMsg = errorBody.error || errorMsg;
                    } catch (e) {
                         // Jika body error bukan JSON, baca sebagai teks
                         errorMsg = await response.text();
                    }
                    throw new Error(errorMsg); // Lemparkan error agar ditangkap di bawah
                }

                // Jika status OK (200), coba parse JSON
                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    // Jika GAGAL parse JSON meskipun status 200 OK
                    console.error("Gagal parse JSON respons:", parseError);
                    // ANGGAP SUKSES KARENA SERVER MENGEMBALIKAN 200 OK
                    // Cari Tx Hash manual jika perlu, atau tampilkan pesan umum
                    statusMessage.innerHTML = `✅ **Mint Likely Successful!** (Frontend failed to read Tx Hash). Check your wallet and Basescan.`;
                    // Jangan lempar error agar tidak menampilkan "Signature Failed"
                    return; // Keluar dari fungsi mintToken
                }
                
                // --- 4. TAMPILKAN HASIL SUKSES (JIKA JSON VALID) ---
                if (result.success && result.txHash) {
                    statusMessage.innerHTML = `✅ **Mint Success!** 1000 $PONGUS sent! <br>Tx: <a href="https://basescan.org/tx/${result.txHash}" target="_blank">${result.txHash.substring(0,10)}...</a>`;
                } else {
                    // Jika JSON valid TAPI result.success = false
                    errorMessage.textContent = `Mint Failed: ${result.error || "Server reported failure."}`;
                }

            } catch (error) { // Menangkap SEMUA error (signature, fetch, parsing, dll)
                console.error("Minting process error:", error); // Log error asli ke konsol
                if (error.code === 4001) {
                    errorMessage.textContent = 'Transaction signature denied by the user.';
                } else {
                    // Tampilkan pesan error yang lebih informatif
                    errorMessage.textContent = `Mint Operation Failed: ${error.message || "Unknown error occurred."}`;
                }
            } finally {
                mintTokenBtn.disabled = false;
            }
        }
        connectWalletBtn.addEventListener('click', connectWallet);
        mintTokenBtn.addEventListener('click', mintToken);
    </script>
</body>
</html>
